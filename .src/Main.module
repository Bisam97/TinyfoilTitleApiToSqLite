' Gambas module file

Private $con As New Connection
Private $Titels As Title[]

Public Sub Main()

  Print "Build Database"
  CreateTable
  AddContent
  Print
  Print "Fertig"


End

Private Function CreateTable()

  Try $con.Close()
  $con.Type = "sqlite3"
  $con.Host = "/usr/lib/hactoolgui"
  $con.Name = ""

  If Exist("/usr/lib/hactoolgui/NXTitleDB.sqlite") Then
    $con.Name = "NXTitleDB.sqlite"
    $con.Open()
    $con.Delete("Title")
  Else

    $con.Open()
    $con.Databases.Add("NXTitleDB.sqlite")
    $con.Close()
    $con.Name = "NXTitleDB.sqlite"
    $con.Open()

  Endif
  $con.ApplyTemplate(File.Load("/usr/lib/hactoolgui/NXTitleDB.Template"))
  $con.Close()


End

Private Function AddContent()

  Dim C, cc As Collection
  Dim t As Title
  Dim r As Result
  Dim d As String[]
  Dim i As Image

  Shell "wget -q -O - https://tinfoil.media/Title/ApiJson/ > /tmp/tinfoil.json" Wait
  C = JSON.Decode(File.Load("/tmp/tinfoil.json"))

  Print "Please Wait this thake a moment"
  $Titels = New Title[]



  For Each cc In C["data"]

    t = New Title(CheckString(cc["id"]), CheckString(String.Mid$(cc["name"], String.InStr(cc["name"], ">") + 1, -4)), CheckString(cc["publisher"]), cc["size"], cc["release_date"], "https://tinfoil.media/i/" & cc["id"] & "/256/256" & String.Mid$(cc["icon"], String.InStr(cc["icon"], "(") + 1 + String.Len("https://tinfoil.media/i/") + 16 + 6, -9))

    $Titels.Add(t)

  Next

  $con.Type = "sqlite3"
  $con.Host = "/usr/lib/hactoolgui"
  $con.Name = "NXTitleDB.sqlite"
  $con.Open()

  For Each t In $Titels


    Shell "wget -q -O - " & t.icon & " > /tmp/icon.tmp" Wait


    d = Split(t.release, "-")


    r = $con.Create("Title")
    r["id"] = t.id
    Try i = Image.Load("/tmp/icon.tmp")

    If Error Then
    Else
      i.Save("/tmp/icon.png")
      r["icon"] = File.Load("/tmp/icon.png")
    Endif

    Try r["name"] = t.name
    Try r["publisher"] = t.publisher
    Try r["release_date"] = Date(d[0], d[1], d[2])
    Try r["size"] = t.Size
    Try r.Update()
    If Error Then

      Print #File.Err, "Error with ID" & t.id
      Error.Clear

    Endif


    Write #File.Out, "."
    Flush #File.Out

  Next

End

Private Function CheckString(s As String) As String

  Dim sa As String[]

  sa = Split(s, "/.,'#?!-:;<>™+[]´`^°~*&()“–’®�")
  Return sa.Join("_")

End

